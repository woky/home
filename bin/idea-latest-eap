#!/bin/zsh
set -e -o pipefail

# Prints version and URL of latest IntelliJ IDEA EAP release.

# They sometimes make the page for a new release long before they publish
# download links to it.

releases=($(
	curl -s https://confluence.jetbrains.com/display/IDEADEV/EAP |\
	sed -nr 's|.*?/IDEADEV/(IDEA\+[0-9\.]+\+EAP).*|\1|p' |\
   	sort -ruV))

for rel in $releases; do
	version=$(
		curl -s https://confluence.jetbrains.com/display/IDEADEV/$rel |\
		sed -nr '/.*?\/ideaIC-([0-9\.]+)\.tar\.gz.*/{s//\1/p;q}')

	if [[ -n $version ]]; then
		url=https://download.jetbrains.com/idea/ideaIC-$version.tar.gz
		print $version $url
		exit 0
	fi
done

exit 1
